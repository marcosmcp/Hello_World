- name: Provisioning Kubernetes 
  hosts: localhost
  become: true

  tasks:

    - include_vars: "/tmp/Hello_World/main.yml"

    - name: configure / Update yum packages
      apt:
        name: '*'
        state: latest
        update_cache: yes

    - name: Install basic packages
      apt:
        name: "{{ packages }}"
        state: present
      become: yes 
      vars:
        packages:
        - python3.7
        - curl
        - gcc
        - make
        - python3-pip
        - npm
        - vim
        - bash-completion
        - htop
        - tmux
        - screen
        - tree
        - telnet 
        - wget 
        - sudo 
        - zip
        - bzip2
        - nodejs
        - python-pip
        - lvm2
        - software-properties-common
        - ca-certificates
        - apt-transport-https 

    - name: Instando o Docker 
      shell: | 
        sudo apt-get update
        sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
        sudo apt-get update
        sudo apt install -y docker-ce
        sudo chmod 777 /var/run/docker.sock

    - name: Install Docker Compose (if configured).
      become: yes
      shell: | 
        curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
        deb https://apt.kubernetes.io/ kubernetes-xenial main
        EOF

    - name: Instalando KubeAdmin
      become: yes
      shell: | 
        sudo apt-get update
        sudo apt-get install -y kubelet kubeadm kubectl
        sudo apt-mark hold kubelet kubeadm kubectl
        exit

    - name: apt update
      become: yes
      apt: 
        name: '*'
        state: latest
        update_cache: yes

    - name: Start Docker service
      service:
        name: docker
        state: started
        enabled: yes
      become: yes
 
    - name: Add user ec2-user docker group
      user:
        name: ubuntu
        groups: docker
        append: yes

    - name: Updating localtime
      command: /bin/cp /usr/share/zoneinfo/America/Sao_Paulo /etc/localtime
      tags: timezone
      become: yes

    - name: AWS CLI
      become: yes
      shell: | 
        curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
        cat <<EOF | sudo tee /etc/apt/sources.list.d/kubernetes.list
        deb https://apt.kubernetes.io/ kubernetes-xenial main
        EOF
        sudo apt-get update
        sudo apt-get install -y kubelet kubeadm kubectl
        sudo apt-mark hold kubelet kubeadm kubectl
        exit
    
    - name: AWS CLI
      become: yes
      shell: | 
        sudo kubeadm init --pod-network-cidr=10.244.0.0/16

    - name: Configurando Client (kubectl)
      become: yes
      shell: | 
        sudo kubeadm init --pod-network-cidr=10.244.0.0/16

    - name: Configurando Client (kubectl)
      become: yes
      shell: | 
        kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/2140ac876ef134e0ed5af15c65e414cf26827915/Documentation/kube-flannel.yml
        kubectl taint nodes --all node-role.kubernetes.io/master-
